# Report Generation Module

## Overview

The `reports.py` module provides comprehensive report generation capabilities for the BIST AI Trading System. It can generate professional PDF and HTML reports for:

1. **Signal Analysis Reports** - Trading signals with confidence scores and recommendations
2. **Backtest Results Reports** - Performance metrics and equity curves
3. **Portfolio Performance Reports** - Holdings, P&L, and allocation analysis

## Features

- **PDF Reports** using ReportLab
  - Professional layouts with tables and charts
  - Customizable styling and branding
  - Archival-quality static reports

- **HTML Reports** using Jinja2 templates
  - Interactive and responsive design
  - Embedded charts as base64 images
  - Easy to view in any browser
  - Custom CSS styling support

- **Visualizations**
  - Signal distribution charts
  - Confidence score histograms
  - Equity curves
  - Drawdown analysis
  - Returns distribution
  - Portfolio allocation pie charts

- **Comprehensive Metrics**
  - Summary statistics
  - Performance metrics tables
  - Detailed position breakdowns
  - Risk-adjusted returns

## Installation

Install the required dependencies:

```bash
pip install reportlab jinja2 matplotlib seaborn
```

Or use the project's requirements file:

```bash
pip install -r requirements.txt
```

## Quick Start

### 1. Signal Analysis Report

```python
from src.ui.reports import generate_html_signal_report, generate_pdf_signal_report

# Sample signals (as generated by SignalGenerator)
signals = [
    {
        'stock_code': 'THYAO',
        'signal': 'STRONG_BUY',
        'confidence_score': 0.85,
        'target_price': 275.0,
        'expected_return': 0.05,
        'rationale': 'Strong institutional buying'
    },
    # ... more signals
]

# Generate HTML report
generate_html_signal_report(
    signals=signals,
    output_path='signal_report.html',
    metadata={'timeframe': '30min', 'date': '2025-11-16'}
)

# Generate PDF report
generate_pdf_signal_report(
    signals=signals,
    output_path='signal_report.pdf'
)
```

### 2. Backtest Results Report

```python
from src.ui.reports import generate_html_backtest_report

# Backtest results (from backtesting engine)
backtest_results = {
    'metrics': {
        'win_rate': 65.5,
        'sharpe_ratio': 1.85,
        'max_drawdown_pct': 12.5,
        'total_return_pct': 45.2,
        # ... more metrics
    },
    'equity_curve': [100000, 102000, 105000, ...],
    'returns': [0.02, -0.01, 0.03, ...]
}

generate_html_backtest_report(
    backtest_results=backtest_results,
    output_path='backtest_report.html',
    metadata={'strategy': 'ML Signal Following', 'period': '2023-2025'}
)
```

### 3. Portfolio Performance Report

```python
from src.ui.reports import generate_html_portfolio_report

# Portfolio data (from PortfolioManager)
portfolio_data = {
    'portfolio_name': 'BIST Trading Portfolio',
    'total_value': 125000.0,
    'cash': 15000.0,
    'total_pnl': 15000.0,
    'positions': [
        {
            'symbol': 'THYAO',
            'shares': 100,
            'cost_basis': 250.0,
            'current_price': 265.0,
            'market_value': 26500.0,
            'unrealized_pnl': 1500.0,
            'unrealized_pnl_pct': 6.0
        },
        # ... more positions
    ]
}

generate_html_portfolio_report(
    portfolio_data=portfolio_data,
    output_path='portfolio_report.html'
)
```

## Custom Configuration

You can customize report appearance and behavior:

```python
from src.ui.reports import ReportConfig, PDFReportGenerator, HTMLReportGenerator

# Create custom configuration
config = ReportConfig(
    title="BIST AI Trading System - Custom Report",
    author="Your Name",
    subject="Trading Analysis",
    page_size="A4",  # or "letter"
    include_charts=True,
    include_metadata=True,
    custom_css="<style>body { font-family: Arial; }</style>"
)

# Use custom config with generators
pdf_gen = PDFReportGenerator(config)
pdf_gen.generate_signal_report(signals, 'custom_report.pdf')

html_gen = HTMLReportGenerator(config)
html_gen.generate_signal_report(signals, 'custom_report.html')
```

## Report Types

### Signal Analysis Report

Contains:
- Summary statistics (total signals, distribution by type)
- Confidence score distribution
- Signal distribution chart
- Detailed signals table with:
  - Stock code
  - Signal type (STRONG_BUY, BUY, HOLD, SELL, STRONG_SELL)
  - Confidence score
  - Target price
  - Expected return
  - Rationale

### Backtest Results Report

Contains:
- Performance metrics:
  - Win rate
  - Total trades
  - Sharpe ratio, Sortino ratio
  - Maximum drawdown
  - Total return
  - Profit factor
- Equity curve chart
- Drawdown chart over time
- Returns distribution histogram
- Detailed metrics table

### Portfolio Performance Report

Contains:
- Portfolio summary:
  - Total value
  - Cash position
  - Positions value
  - Realized/Unrealized P&L
  - Total return %
- Portfolio allocation chart (pie chart)
- Position details table with:
  - Symbol
  - Shares owned
  - Cost basis
  - Current price
  - Market value
  - Unrealized P&L

## Integration with Trading System

### With Signal Generator

```python
from src.signals.generator import SignalGenerator
from src.ui.reports import generate_html_signal_report

# Generate signals
generator = SignalGenerator()
signals = generator.generate_batch_signals(stocks_data)

# Convert to report format
report_signals = [signal.to_dict() for signal in signals.values()]

# Generate report
generate_html_signal_report(
    signals=report_signals,
    output_path='daily_signals.html',
    metadata={'date': datetime.now().isoformat()}
)
```

### With Backtesting Engine

```python
from src.backtesting.simulator import BacktestSimulator
from src.backtesting.metrics import calculate_all_metrics
from src.ui.reports import generate_pdf_backtest_report

# Run backtest
simulator = BacktestSimulator()
results = simulator.run_backtest(strategy, data)

# Calculate metrics
metrics = calculate_all_metrics(
    returns=results['returns'],
    equity_curve=results['equity_curve']
)

# Generate report
backtest_data = {
    'metrics': metrics.to_dict(),
    'equity_curve': results['equity_curve'],
    'returns': results['returns']
}

generate_pdf_backtest_report(
    backtest_results=backtest_data,
    output_path='backtest_results.pdf'
)
```

### With Portfolio Manager

```python
from src.portfolio.manager import PortfolioManager
from src.ui.reports import generate_html_portfolio_report

# Get portfolio data
portfolio = PortfolioManager.load_from_json('portfolio.json')
current_prices = get_current_prices()  # Your price fetching function

# Get portfolio summary
summary = portfolio.get_portfolio_summary(current_prices)

# Generate report
generate_html_portfolio_report(
    portfolio_data=summary,
    output_path='portfolio_report.html',
    metadata={'as_of': datetime.now().strftime('%Y-%m-%d')}
)
```

## Examples

See `/examples/generate_reports_example.py` for complete working examples of all report types.

Run the examples:

```bash
cd /home/user/BISTML
python examples/generate_reports_example.py
```

This will generate sample reports in the `output/` directory.

## API Reference

### Convenience Functions

#### `generate_html_signal_report(signals, output_path, config=None, metadata=None)`
Generate HTML signal analysis report.

**Parameters:**
- `signals` (List[Dict]): List of signal dictionaries
- `output_path` (str): Path to save HTML file
- `config` (ReportConfig, optional): Report configuration
- `metadata` (Dict, optional): Additional metadata to include

#### `generate_pdf_signal_report(signals, output_path, config=None, metadata=None)`
Generate PDF signal analysis report.

#### `generate_html_backtest_report(backtest_results, output_path, config=None, metadata=None)`
Generate HTML backtest results report.

**Parameters:**
- `backtest_results` (Dict): Backtest results with 'metrics', 'equity_curve', 'returns'
- `output_path` (str): Path to save HTML file
- `config` (ReportConfig, optional): Report configuration
- `metadata` (Dict, optional): Additional metadata

#### `generate_pdf_backtest_report(backtest_results, output_path, config=None, metadata=None)`
Generate PDF backtest results report.

#### `generate_html_portfolio_report(portfolio_data, output_path, config=None, metadata=None)`
Generate HTML portfolio performance report.

**Parameters:**
- `portfolio_data` (Dict): Portfolio summary data
- `output_path` (str): Path to save HTML file
- `config` (ReportConfig, optional): Report configuration
- `metadata` (Dict, optional): Additional metadata

#### `generate_pdf_portfolio_report(portfolio_data, output_path, config=None, metadata=None)`
Generate PDF portfolio performance report.

### Classes

#### `ReportConfig`
Configuration for report generation.

**Attributes:**
- `title` (str): Report title
- `author` (str): Report author
- `subject` (str): Report subject
- `page_size` (str): Page size ('A4' or 'letter')
- `include_charts` (bool): Whether to include charts
- `include_metadata` (bool): Whether to include metadata
- `logo_path` (str, optional): Path to logo image
- `custom_css` (str, optional): Custom CSS for HTML reports

#### `PDFReportGenerator`
PDF report generator using ReportLab.

**Methods:**
- `generate_signal_report(signals, output_path, metadata=None)`
- `generate_backtest_report(backtest_results, output_path, metadata=None)`
- `generate_portfolio_report(portfolio_data, output_path, metadata=None)`

#### `HTMLReportGenerator`
HTML report generator using Jinja2.

**Methods:**
- `generate_signal_report(signals, output_path, metadata=None)`
- `generate_backtest_report(backtest_results, output_path, metadata=None)`
- `generate_portfolio_report(portfolio_data, output_path, metadata=None)`

## Data Formats

### Signal Dictionary Format

```python
{
    'stock_code': str,           # Stock ticker symbol
    'signal': str,               # STRONG_BUY, BUY, HOLD, SELL, STRONG_SELL
    'confidence': str,           # VERY_HIGH, HIGH, MEDIUM, LOW, VERY_LOW
    'confidence_score': float,   # 0.0 to 1.0
    'current_price': float,      # Current stock price
    'target_price': float,       # Predicted target price
    'expected_return': float,    # Expected return (decimal)
    'position_size': float,      # Recommended position size (0-1)
    'risk_score': float,         # Risk score (0-1)
    'stop_loss': float,          # Suggested stop loss price
    'take_profit': float,        # Suggested take profit price
    'rationale': str,            # Explanation of signal
    'model_contributions': dict, # Model contribution weights
    'metadata': dict             # Additional metadata
}
```

### Backtest Results Dictionary Format

```python
{
    'metrics': {
        'win_rate': float,                # Win rate percentage
        'total_trades': int,              # Total number of trades
        'winning_trades': int,            # Number of winning trades
        'losing_trades': int,             # Number of losing trades
        'sharpe_ratio': float,            # Sharpe ratio
        'sortino_ratio': float,           # Sortino ratio
        'max_drawdown': float,            # Max drawdown (decimal)
        'max_drawdown_pct': float,        # Max drawdown percentage
        'total_return': float,            # Total return (decimal)
        'total_return_pct': float,        # Total return percentage
        'annualized_return': float,       # Annualized return
        'profit_factor': float,           # Profit factor
        # ... more metrics
    },
    'equity_curve': List[float],          # Equity values over time
    'returns': List[float]                # Return for each trade
}
```

### Portfolio Data Dictionary Format

```python
{
    'portfolio_name': str,                # Portfolio name
    'currency': str,                      # Currency (e.g., 'TRY')
    'total_value': float,                 # Total portfolio value
    'cash': float,                        # Cash balance
    'positions_value': float,             # Total positions value
    'num_positions': int,                 # Number of positions
    'unrealized_pnl': float,              # Unrealized P&L
    'realized_pnl': float,                # Realized P&L
    'total_pnl': float,                   # Total P&L
    'total_return_pct': float,            # Total return percentage
    'last_updated': str,                  # Last update timestamp (ISO format)
    'positions': [
        {
            'symbol': str,                # Stock symbol
            'shares': float,              # Number of shares
            'cost_basis': float,          # Average cost per share
            'current_price': float,       # Current market price
            'market_value': float,        # Current market value
            'total_cost': float,          # Total cost basis
            'unrealized_pnl': float,      # Unrealized P&L
            'unrealized_pnl_pct': float   # Unrealized P&L percentage
        },
        # ... more positions
    ]
}
```

## Styling and Customization

### Custom CSS for HTML Reports

```python
custom_css = """
<style>
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f0f0f0;
    }
    .container {
        max-width: 1400px;
        background-color: white;
    }
    h1 {
        color: #0066cc;
        border-bottom: 3px solid #0066cc;
    }
    /* ... more custom styles */
</style>
"""

config = ReportConfig(custom_css=custom_css)
```

### Logo Integration

```python
config = ReportConfig(
    logo_path='/path/to/logo.png',
    include_metadata=True
)
```

## Performance Considerations

- **Chart Generation**: Charts are generated on-the-fly using matplotlib. For large datasets, consider:
  - Limiting the number of data points
  - Pre-generating charts and passing as base64
  - Using lower DPI for faster generation

- **Large Reports**: For reports with many signals or positions:
  - Use pagination (reports automatically limit to top N items)
  - Generate separate reports for different segments
  - Consider using database-backed rendering for very large datasets

## Troubleshooting

### ReportLab not available
```
ImportError: ReportLab is required for PDF generation
```
**Solution:** Install reportlab: `pip install reportlab`

### Jinja2 not available
HTML reports will still work with basic templates, but for better formatting:
```bash
pip install jinja2
```

### Charts not displaying
Ensure matplotlib backend is set correctly:
```python
import matplotlib
matplotlib.use('Agg')  # Non-interactive backend
```

### Large file sizes
If PDF/HTML files are too large:
- Reduce chart DPI (default is 150)
- Limit number of items in tables
- Compress images before embedding

## License

Part of the BIST AI Trading System.

## Author

BIST AI Trading System Team
Date: 2025-11-16
